<script>
  const lang = new URLSearchParams(location.search).get('lang') || 'en';
  if (lang !== 'en') {
    document.querySelectorAll('[data-text]').forEach(el => {
      const text = el.dataset.text;
      fetch('/translate', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text, lang})
      })
      .then(r => r.json())
      .then(d => el.innerHTML = d.translated)
      .catch(() => {});
    });
  }

  // Mic recording (HTTPS only)
  let recorder, audioBlob;
  document.getElementById('recordBtn').onclick = async () => {
    if (!recorder) {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        recorder = new MediaRecorder(stream);
        const chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          audioBlob = new Blob(chunks, {type: 'audio/wav'});
          document.getElementById('audioPreview').src = URL.createObjectURL(audioBlob);
          document.getElementById('audioPreview').style.display = 'block';
        };
        recorder.start();
        document.getElementById('recordBtn').innerHTML = 'Stop';
      } catch (e) {
        alert('Mic access denied. Allow HTTPS mic permission.');
      }
    } else {
      recorder.stop();
      recorder.stream.getTracks().forEach(t => t.stop());
      recorder = null;
      document.getElementById('recordBtn').innerHTML = 'Record';
    }
  };
</script>
