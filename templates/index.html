<!DOCTYPE html>
<html>
<head>
  <title>Parkinson Detector</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {font-family: 'Segoe UI'; text-align: center; background: #f0f8ff; padding:  2rem;}
    .container {max-width: 600px; margin: auto; background: white; padding: 2.5rem; border-radius: 16px;}
    select, button {margin: 0.5rem; padding: 0.8rem; border-radius: 8px;}
    #record {background: #dc2626; color: white;}
    #loading {display: none;}
    .result {margin-top: 1rem; padding: 1rem; border-radius: 8px;}
    .high {background: #fee2e2; color: #dc2626;}
    .low {background: #dcfce7; color: #16a34a;}
  </style>
</head>
<body>
  <div class="container">
    <h1>Parkinson Voice Detector</h1>
    
    <select onchange="location.href='?lang='+this.value">
      {% for code, name in languages.items() %}
        <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>

    <form method="post" enctype="multipart/form-data">
      <input type="file" name="file" accept="audio/*">
      <br><br>
      <button type="button" id="record">Record Voice</button>
      <audio id="audio" controls style="display:none"></audio>
      <br><br>
      <button type="submit" id="btn">
        <span id="text">Analyze</span>
        <span id="loading">Processing...</span>
      </button>
    </form>

    {% if result %}
      <div class="result {% if result.risk == 'HIGH' %}high{% else %}low{% endif %}" id="result">
        {% if result.error %}
          <p style="color:red" data-text="Error: {{ result.error }}"></p>
        {% else %}
          <p data-text="Risk Score: <strong>{{ "%.1f"|format(result.risk_score * 100) }}%</strong>"></p>
          <p data-text="{% if result.risk == 'HIGH' %}HIGH RISK — Consult doctor{% else %}LOW RISK — Healthy{% endif %}"></p>
        {% endif %}
      </div>
    {% endif %}
  </div>

  <script>
    let recorder, audioBlob;
    document.getElementById('record').onclick = async () => {
      const stream = await navigator.mediaDevices.getUserMedia({audio: true});
      recorder = new MediaRecorder(stream);
      const chunks = [];
      recorder.ondataavailable = e => chunks.push(e.data);
      recorder.onstop = () => {
        audioBlob = new Blob(chunks, {type: 'audio/wav'});
        const url = URL.createObjectURL(audioBlob);
        const audio = document.getElementById('audio');
        audio.src = url; audio.style.display = 'block';
        const form = document.querySelector('form');
        const data = new FormData(form);
        data.append('audio', audioBlob, 'recording.wav');
        form.onsubmit = (e) => { e.preventDefault(); form.submit(); };
      };
      recorder.start();
      document.getElementById('record').textContent = 'Stop';
      document.getElementById('record').onclick = () => {
        recorder.stop(); stream.getTracks().forEach(t => t.stop());
        document.getElementById('record').textContent = 'Record Voice';
      };
    };

    // Auto-translate on load
    const lang = new URLSearchParams(location.search).get('lang') || 'en';
    if (lang !== 'en') {
      document.querySelectorAll('[data-text]').forEach(el => {
        fetch('/translate', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({text: el.dataset.text, lang: lang})
        }).then(r => r.json()).then(data => el.innerHTML = data.translated);
      });
    }

    document.querySelector('form').onsubmit = () => {
      document.getElementById('text').style.display = 'none';
      document.getElementById('loading').style.display = 'inline';
    };
  </script>
</body>
</html>
