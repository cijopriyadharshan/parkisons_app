<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parkinson Detector</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root { --primary: #007acc; --danger: #dc2626; --success: #16a34a; }
    body {font-family: 'Segoe UI', sans-serif; margin:0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height:100vh;}
    .container {max-width: 500px; margin: 2rem auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow:hidden;}
    .header {background: var(--primary); color:white; padding:1.5rem; text-align:center;}
    .content {padding:2rem;}
    .lang-select {margin-bottom:1rem; text-align:center;}
    select {padding:0.5rem 1rem; border-radius:8px; border:none; background:#f1f1f1;}
    .upload-area {border:3px dashed #ccc; border-radius:16px; padding:2rem; text-align:center; margin:1rem 0; transition:0.2s ease;}
    .upload-area.dragover {border-color: var(--primary); background: rgba(0, 122, 204, 0.08);}
    .file-name {margin-top:0.75rem; font-size:0.9rem; color:#555;}
    .btn {background:var(--primary); color:white; padding:1rem 2rem; border:none; border-radius:12px; font-size:1.1rem; cursor:pointer; width:100%; margin:1rem 0;}
    .btn:disabled {opacity:0.7;}
    .progress {height:8px; background:#eee; border-radius:4px; overflow:hidden; margin:1rem 0; display:none;}
    .progress-bar {height:100%; background:var(--primary); width:0%; transition:0.3s;}
    .result {margin-top:1.5rem; padding:1.5rem; border-radius:16px; text-align:center; font-weight:bold;}
    .high {background:#fee2e2; color:var(--danger); border:2px solid #fecaca;}
    .low {background:#dcfce7; color:var(--success); border:2px solid #bbf7d0;}
    .mic-btn {background:#dc2626;}
    audio {width:100%; margin:1rem 0;}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1 data-text="Parkinson Detector">Parkinson Detector</h1>
      <p data-text="Upload or record voice • Result in &lt;25s">Upload or record voice • Result in &lt;25s</p>
    </div>

    <div class="content">
      <div class="lang-select">
        <select onchange="location.href='?lang='+this.value">
          {% for code, name in languages.items() %}
            <option value="{{ code }}" {% if lang == code %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>

      <form method="post" enctype="multipart/form-data" id="uploadForm">
        <div class="upload-area" id="dropArea">
          <p data-text="Drop file or click (AMR, MP3, WAV)">Drop file or click (AMR, MP3, WAV)</p>
          <input type="file" name="file" accept="audio/*" id="fileInput" style="display:none"/>
          <div class="file-name" id="fileName" data-text="No file selected">No file selected</div>
        </div>

        <button type="button" class="btn mic-btn" id="recordBtn">
          <span data-text="Record">Record</span>
        </button>
        <audio id="audioPreview" controls style="display:none"></audio>

        <button type="submit" class="btn" id="analyzeBtn">
          <span id="btnText" data-text="Analyze">Analyze</span>
          <span id="loadingText" style="display:none" data-text="Processing...">Processing...</span>
        </button>

        <div class="progress" id="progressBar">
          <div class="progress-bar" id="progressFill"></div>
        </div>
      </form>

      <div id="resultContainer">
        {% if result %}
          <div class="result {% if result.error %}high{% elif result.risk == 'HIGH' %}high{% else %}low{% endif %}">
            {% if result.error %}
              <p data-text="{{ result.error }}">{{ result.error }}</p>
            {% else %}
              <p data-text="Risk Score: <strong>{{ "%.1f"|format(result.risk_score * 100) }}%</strong>">
                Risk Score: <strong>{{ "%.1f"|format(result.risk_score * 100) }}%</strong>
              </p>
              <p data-text="{% if result.risk == 'HIGH' %}HIGH RISK — Consult doctor{% else %}LOW RISK — Healthy{% endif %}">
                {% if result.risk == 'HIGH' %}HIGH RISK — Consult doctor{% else %}LOW RISK — Healthy{% endif %}
              </p>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let recorder = null;
      let audioBlob = null;
      let progressTimer = null;
      let pendingFile = null;

      const lang = new URLSearchParams(location.search).get('lang') || 'en';
      const uploadForm = document.getElementById('uploadForm');
      const recordBtn = document.getElementById('recordBtn');
      const recordLabel = recordBtn.querySelector('span');
      const analyzeBtn = document.getElementById('analyzeBtn');
      const btnText = document.getElementById('btnText');
      const loadingText = document.getElementById('loadingText');
      const progressBar = document.getElementById('progressBar');
      const progressFill = document.getElementById('progressFill');
      const fileInput = document.getElementById('fileInput');
      const fileName = document.getElementById('fileName');
      const audioPreview = document.getElementById('audioPreview');
      const dropArea = document.getElementById('dropArea');
      const resultContainer = document.getElementById('resultContainer');

      const defaultFileLabel = fileName.textContent;

      const applyTranslations = (root = document) => {
        if (lang === 'en') return;
        root.querySelectorAll('[data-text]').forEach(el => {
          if (el.dataset.translated === 'true') return;
          const text = el.dataset.text;
          fetch('/translate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text, lang})
          })
          .then(r => r.json())
          .then(d => {
            el.innerHTML = d.translated;
            el.dataset.translated = 'true';
          })
          .catch(() => {});
        });
      };

      const setAnalyzeEnabled = (enabled) => {
        analyzeBtn.disabled = !enabled;
      };

      const resetProgress = () => {
        if (progressTimer) clearInterval(progressTimer);
        progressFill.style.width = '0%';
        progressBar.style.display = 'none';
      };

      const startProgress = () => {
        progressBar.style.display = 'block';
        progressFill.style.width = '20%';
        let width = 20;
        progressTimer = setInterval(() => {
          width = Math.min(width + Math.random() * 15, 90);
          progressFill.style.width = `${width}%`;
        }, 500);
      };

      const finishProgress = () => {
        progressFill.style.width = '100%';
        setTimeout(resetProgress, 400);
      };

      const showLoading = (isLoading) => {
        btnText.style.display = isLoading ? 'none' : 'inline';
        loadingText.style.display = isLoading ? 'inline' : 'none';
        analyzeBtn.disabled = isLoading;
        if (isLoading) startProgress(); else finishProgress();
      };

      const clearFileSelection = () => {
        fileInput.value = '';
        fileName.textContent = defaultFileLabel;
        fileName.dataset.translated = 'false';
        applyTranslations(fileName.parentElement);
        pendingFile = null;
      };

      const updateResult = (result) => {
        if (!result) {
          resultContainer.innerHTML = '';
          return;
        }
        if (result.error) {
          resultContainer.innerHTML = `<div class="result high"><p data-text="${result.error}">${result.error}</p></div>`;
        } else {
          const riskText = result.risk === 'HIGH' ? 'HIGH RISK — Consult doctor' : 'LOW RISK — Healthy';
          resultContainer.innerHTML = `
            <div class="result ${result.risk === 'HIGH' ? 'high' : 'low'}">
              <p data-text="Risk Score: <strong>${(result.risk_score * 100).toFixed(1)}%</strong>">
                Risk Score: <strong>${(result.risk_score * 100).toFixed(1)}%</strong>
              </p>
              <p data-text="${riskText}">${riskText}</p>
            </div>
          `;
        }
        applyTranslations(resultContainer);
      };

      applyTranslations();
      setAnalyzeEnabled(false);

      dropArea.addEventListener('click', () => fileInput.click());
      ['dragenter', 'dragover'].forEach(evt => dropArea.addEventListener(evt, e => { e.preventDefault(); dropArea.classList.add('dragover'); }));
      ['dragleave', 'drop'].forEach(evt => dropArea.addEventListener(evt, e => { e.preventDefault(); if (evt === 'drop') setFileFromUpload(e.dataTransfer.files[0]); dropArea.classList.remove('dragover'); }));

      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          audioBlob = null;
          pendingFile = file;
          fileName.textContent = file.name;
          fileName.dataset.translated = 'false';
          applyTranslations(fileName.parentElement);
          audioPreview.style.display = 'none';
          setAnalyzeEnabled(true);
        } else {
          setAnalyzeEnabled(!!audioBlob);
          clearFileSelection();
        }
      });

      recordBtn.addEventListener('click', async () => {
        if (!recorder) {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({audio: true});
            const chunks = [];
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
              audioBlob = new Blob(chunks, {type: 'audio/wav'});
              audioPreview.src = URL.createObjectURL(audioBlob);
              audioPreview.style.display = 'block';
              clearFileSelection();
              setAnalyzeEnabled(true);
            };
            recorder.start();
            recordLabel.textContent = 'Stop';
            applyTranslations(recordBtn);
            setAnalyzeEnabled(false);
          } catch (e) {
            alert('Mic access denied. Allow HTTPS.');
          }
        } else {
          recorder.stop();
          recorder.stream.getTracks().forEach(t => t.stop());
          recorder = null;
          recordLabel.textContent = 'Record';
          applyTranslations(recordBtn);
        }
      });

      uploadForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData();
        if (audioBlob) formData.append('file', audioBlob, 'recording.wav');
        else if (pendingFile || fileInput.files[0]) formData.append('file', pendingFile || fileInput.files[0]);

        if (!formData.has('file')) {
          updateResult({error: 'No file selected'});
          return;
        }
        pendingFile = null;

        showLoading(true);

        try {
          const response = await fetch('/', {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'Accept': 'application/json'
            }
          });

          console.log('Status:', response.status);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const data = await response.json();
          updateResult(data);
        } catch (err) {
          console.error('Fetch error:', err);
          updateResult({error: 'Network or server error'});
        } finally {
          showLoading(false);
        }
      });
    });
  </script>
</body>
</html>
